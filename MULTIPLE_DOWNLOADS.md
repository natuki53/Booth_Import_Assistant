# 複数ダウンロードリンク対応ガイド

VRChatアバター改変アセットでは、1つの商品に複数のダウンロードリンクが含まれることがよくあります。

例：
- 萌ちゃん用
- 桔梗ちゃん用
- 舞夜ちゃん用
- マテリアル共通

このガイドでは、複数ダウンロードリンクの扱い方を説明します。

---

## 📦 データ構造

### JSON形式

```json
{
  "id": "booth_1234567",
  "title": "もふもふ衣装セット",
  "author": "もふまじっく",
  "downloadUrls": [
    {
      "url": "https://booth.pm/downloadables/111",
      "label": "萌ちゃん用"
    },
    {
      "url": "https://booth.pm/downloadables/222",
      "label": "桔梗ちゃん用"
    },
    {
      "url": "https://booth.pm/downloadables/333",
      "label": "マテリアル共通"
    }
  ]
}
```

### 従来形式との違い

**変更前（単一ダウンロード）:**
```json
{
  "downloadUrl": "https://booth.pm/downloadables/111"
}
```

**変更後（複数ダウンロード対応）:**
```json
{
  "downloadUrls": [
    { "url": "...", "label": "萌ちゃん用" },
    { "url": "...", "label": "桔梗ちゃん用" }
  ]
}
```

---

## 🎮 Unity Editor での使用方法

### パターン1: 単一ダウンロード

```
┌────────────────────────────────┐
│ [サムネ] もふもふ衣装           │
│  64x64   作者: もふまじっく      │
│          購入日: 2025-10-27     │
│                                 │
│                [📥 ダウンロード] │
│                [🌐 商品ページ]   │
└────────────────────────────────┘
```

### パターン2: 2〜3個のバリエーション

```
┌────────────────────────────────┐
│ [サムネ] メイド衣装セット       │
│  64x64   作者: もふまじっく      │
│          購入日: 2025-10-27     │
│                                 │
│            📥 ダウンロード:      │
│            [萌ちゃん用]         │
│            [桔梗ちゃん用]       │
│            [マテリアル共通]     │
│            [🌐 商品ページ]      │
└────────────────────────────────┘
```

**特徴**: 各バリエーション用のボタンが見やすく表示されます。

### パターン3: 4個以上のバリエーション（ドロップダウン）

```
┌────────────────────────────────┐
│ [サムネ] 衣装10種セット         │
│  64x64   作者: もふまじっく      │
│          購入日: 2025-10-27     │
│                                 │
│     📥 バリエーション選択:       │
│     [萌ちゃん用         ▼]      │
│     [選択中をDL]                │
│     [全てDL]                    │
│     [🌐 商品ページ]             │
└────────────────────────────────┘
```

**特徴**: 
- ドロップダウンメニューで選択
- 縦スペースを節約
- 「全てDL」で一括ダウンロード可能

**ドロップダウンの例:**
```
┌──────────────────┐
│ 萌ちゃん用        │ ← 選択中
│ 桔梗ちゃん用      │
│ 舞夜ちゃん用      │
│ セレスティア用    │
│ リリス用         │
│ マテリアル共通    │
└──────────────────┘
```

---

## 📥 ダウンロードと自動処理

### ダウンロード方法

**すべてのパターン共通:**
1. Unity の BOOTH Library でダウンロードボタンをクリック
2. 開かれたBOOTHページでダウンロードボタンをクリック
3. **ファイル名の変更は不要です**（元のファイル名のままでOK）
4. Chrome拡張が自動的にファイルと商品IDを紐付けます

### 自動処理の仕組み

1. **同期時**: Chrome拡張がダウンロードURLと商品IDの対応表を作成
2. **ダウンロード開始時**: Chrome拡張がダウンロードを検知し、商品IDを特定
3. **ダウンロード完了時**: Bridgeにファイル名と商品IDを通知
4. **自動展開**: Bridgeが対応するディレクトリに展開

### 展開先ディレクトリ

```
Assets/ImportedAssets/booth_1234567/
├── variant_1/          （萌ちゃん用）
│   └── ...展開されたファイル
├── variant_2/          （桔梗ちゃん用）
│   └── ...展開されたファイル
└── variant_3/          （マテリアル共通）
    └── ...展開されたファイル
```

単一ダウンロードの場合は、直接 `booth_1234567/` に展開されます。

---

## 🔧 実装詳細

### ブラウザ拡張（content.js）

```javascript
// 複数のダウンロードリンクを取得
const downloadLinks = parentElement.querySelectorAll('a[href*="/downloadables/"]');
let downloadUrls = [];

downloadLinks.forEach((link) => {
  downloadUrls.push({
    url: link.href,
    label: link.textContent.trim()
  });
});
```

### Unity Editor拡張（BoothLibraryWindow.cs）

```csharp
// 複数ダウンロードボタンを表示
if (asset.downloadUrls.Length == 1) {
    // 単一の場合
    GUILayout.Button("ダウンロード");
} else {
    // 複数の場合
    GUILayout.Label("ダウンロード:");
    foreach (var downloadUrl in asset.downloadUrls) {
        GUILayout.Button(downloadUrl.label);
    }
}
```

### Bridge（bridge.js）

```javascript
// booth_<id>_<num>.zip のパターンを検出
const match = filename.match(/^booth_(\d+)(?:_\d+)?\.zip$/);

// サブフォルダに展開
const variantMatch = filename.match(/^booth_\d+_(\d+)\.zip$/);
if (variantMatch) {
  subFolder = `variant_${variantMatch[1]}`;
}
```

---

## 🎯 ユースケース

### ケース1: 複数アバター対応の衣装

```
商品: 「メイド衣装セット for VRC」
├── 萌ちゃん用.zip
├── 桔梗ちゃん用.zip
├── 舞夜ちゃん用.zip
└── セレスティア用.zip
```

**操作:**
1. 必要なアバター用のボタンをクリック
2. BOOTHからダウンロード
3. `booth_123456_1.zip` にリネーム（萌ちゃん用なら_1）
4. Downloadsフォルダに配置
5. 自動展開される

### ケース2: マテリアルとメッシュが別

```
商品: 「もふもふ衣装＋マテリアル」
├── mesh.zip（メッシュデータ）
└── materials.zip（テクスチャ・マテリアル）
```

**操作:**
1. 「mesh.zip」ボタンをクリック → `booth_123456_1.zip` で保存
2. 「materials.zip」ボタンをクリック → `booth_123456_2.zip` で保存
3. 両方が `Assets/ImportedAssets/booth_123456/` 内に展開される

### ケース3: 10種類のアバター対応（ドロップダウン）

```
商品: 「汎用衣装10種対応」
├── 萌ちゃん用
├── 桔梗ちゃん用
├── 舞夜ちゃん用
├── セレスティア用
├── リリス用
├── 竜胆ちゃん用
├── マヌカ用
├── 森羅用
├── アバター9
└── マテリアル共通
```

**操作パターンA（個別ダウンロード）:**
1. ドロップダウンで「萌ちゃん用」を選択
2. 「選択中をDL」ボタンをクリック
3. `booth_123456_1.zip` で保存

**操作パターンB（一括ダウンロード）:**
1. 「全てDL」ボタンをクリック
2. 確認ダイアログで「はい」を選択
3. 10個のダウンロードページが順次開く（0.5秒間隔）
4. 各ページから順番にダウンロード
   - `booth_123456_1.zip`（萌ちゃん用）
   - `booth_123456_2.zip`（桔梗ちゃん用）
   - ...
   - `booth_123456_10.zip`（マテリアル共通）

### ケース3: バリエーション展開

```
商品: 「パーカー（カラーバリエーション3色）」
├── red.zip
├── blue.zip
└── green.zip
```

**操作:**
1. 好きな色のボタンをクリック
2. 必要に応じて複数ダウンロード可能
3. それぞれ異なるサブフォルダに展開

---

## ⚠️ 注意事項

### ファイル名の重要性

**必ず以下の形式にしてください:**
```
booth_<商品ID>_<番号>.zip
```

例：
- ✅ `booth_1234567_1.zip`
- ✅ `booth_1234567_2.zip`
- ❌ `booth_1234567.zip` (複数ある場合は番号必須)
- ❌ `moe_avatar.zip` (Bridgeが検知しない)

### ダウンロード順序

ボタンの順序とファイル名の番号を一致させることを推奨：
- 1番目のボタン → `_1.zip`
- 2番目のボタン → `_2.zip`
- 3番目のボタン → `_3.zip`

### ダウンロードフォルダ

必ず以下のフォルダに保存してください：
- Windows: `C:\Users\<ユーザー名>\Downloads`
- Mac: `/Users/<ユーザー名>/Downloads`

---

## 🔍 トラブルシューティング

### Q: 複数ダウンロードボタンが表示されない

**A:** BOOTHページに複数のダウンロードリンクが存在しない可能性があります。

確認方法：
1. ブラウザの開発者ツール（F12）を開く
2. Consoleタブで以下を実行：

```javascript
const items = extractBoothItems();
console.log(items[0].downloadUrls);
```

### Q: 自動展開されない

**A:** ファイル名が正しいか確認してください。

```javascript
// ファイル名が正規表現にマッチするか確認
const filename = "booth_1234567_1.zip";
const match = filename.match(/^booth_(\d+)(?:_\d+)?\.zip$/);
console.log(match); // nullでなければOK
```

### Q: 同じフォルダに展開されてしまう

**A:** `_1`, `_2` の番号が正しくない可能性があります。

Bridgeのログを確認：
```
[BoothBridge] ZIP検知: booth_1234567_1.zip → ID: booth_1234567
[BoothBridge] サブフォルダに展開: variant_1
```

---

これで複数ダウンロードリンクの対応は完了です！

VRChatアバター改変がよりスムーズになります 🎨✨

